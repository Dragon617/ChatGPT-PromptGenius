{% extends "base.html" %}

{% block content %}
<main class="container-xxl overflow-y-scroll py-2 py-md-3" id="class-edit-container">
    <div class="row row-cols-2 row-cols-xl-6 row-cols-lg-4 row-cols-md-3 row-cols-sm-2" id="language-row">
        <div class="col">
            <div class="col d-flex align-items-center justify-content-evenly">
                <button class="btn btn-success disabled" id="class-order-save-btn">
                    <div class="spinner-border spinner-border-sm d-none"></div>
                    <span class="d-none finished-indicator"><i class="bi bi-check-lg"></i></span>
                    <i class="bi bi-sort-down"></i>
                </button>
            </div>
        </div>
    </div>
</main>

<div class="modal fade" id="edit-icon-dialog" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1">
    <div class="modal-dialog modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5">Edit icon style</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row row-cols-2">
                    <div class="col">
                        <div class="input-group mb-3" id="icon-name-input">
                            <span class="input-group-text"><i class="bi bi-grid-fill"></i></span>
                            <input type="text" class="form-control" placeholder="Icon ID">
                            <a href="https://icons.getbootstrap.com/" target="_blank" class="input-group-text"><i
                                    class="bi bi-link"></i></a>
                        </div>
                    </div>
                    <div class="col">
                        <div class="input-group mb-3" id="icon-style-input">
                            <span class="input-group-text"><i class="bi bi-palette"></i></span>
                            <input type="text" class="form-control" placeholder="Style (HEX color)">
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" id="edit-icon-ok-btn">
                    <span>OK</span>
                </button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade modal-xl" id="edit-child-dialog" data-bs-backdrop="static" data-bs-keyboard="false"
    tabindex="-1">
    <div class="modal-dialog modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5">Edit childrens</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="child-class-edit-container">
                <div class="row row-cols-2 row-cols-xl-5 row-cols-lg-4 row-cols-md-3 row-cols-sm-2"
                    id="child-language-row">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" id="add-child-class-btn">
                    <span>Add child</span>
                </button>
                <button type="button" class="btn btn-primary" id="edit-child-class-ok-btn">
                    <div class="spinner-border spinner-border-sm d-none"></div>
                    <span class="d-none finished-indicator"><i class="bi bi-check-lg"></i></span>
                    <span>OK</span>
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block script %}
<script>
    const child_class_row_common_class = 'row my-3 py-2 row-cols-2 row-cols-xl-5 row-cols-lg-4 row-cols-md-3 row-cols-sm-2 rounded shadow-sm'
    const class_row_common_class = 'row my-3 py-2 row-cols-2 row-cols-xl-6 row-cols-lg-4 row-cols-md-3 row-cols-sm-2 rounded shadow-sm'
    const class_order_save_btn = $('#class-order-save-btn');
    const warning_toast = bootstrap.Toast.getOrCreateInstance($('#warning-toast'));

    window.onload = () => {
        action_sidebar_bs = new bootstrap.Offcanvas($('#action-sidebar'));
        edit_icon_dialog_bs = new bootstrap.Modal($('#edit-icon-dialog'));
        edit_child_dialog_bs = new bootstrap.Modal($('#edit-child-dialog'));

        Promise.all([
            init_language_select(),
            render_page_basic(),
            render_user_specific()
        ]).then(() => {
            $('#class-sidebar-toggler').addClass('disabled');
            $('#class-sidebar-toggler i').addClass('text-secondary');
            $('#search-input-group input').attr('disabled', 'disabled');
            $('#search-input-group button').attr('disabled', 'disabled');
            $('#nav-submit-btn').attr('disabled', 'disabled');
            $('#user-group button').addClass('disabled');
        })

        get_data('/fetch_lan').then((languages) => {
            var class_promises = [];
            languages.forEach((item) => {
                $('#language-row, #child-language-row').append($(`
                    <div class="col lan-col" lan-code="${item.code}">
                        <h5><span class="badge text-bg-info w-100 language-badge mt-2">${item.name}</span></h5>
                    </div>
                `));
                class_promises.push(get_data(`/fetch_classes/${item.code}`));
            });
            $('#class-edit-container').append(gen_new_class_row(languages));

            Promise.all(class_promises).then((multilan_classes) => {
                var num_classes = multilan_classes[0].length;
                var num_lans = multilan_classes.length;

                for (var class_i = 0; class_i < num_classes; class_i++) {
                    var repr_class = multilan_classes[0][class_i];
                    var class_row = $(`
                        <div class="${class_row_common_class} class-row" 
                        class-id="${repr_class.ID}" style="background-color: #eee">
                            <div class="col d-flex align-items-center justify-content-evenly">
                                <button class="btn text-light edit-icon-btn" class-id="${repr_class.ID}"
                                style="background-color: #${repr_class.icon_style}">
                                    <i class="bi bi-${repr_class.icon}"></i>
                                </button>
                                <button class="btn btn-outline-danger class-remove-btn">
                                    <i class="bi bi-trash"></i>
                                </button>
                                <button class="btn btn-outline-primary edit-child-btn">
                                    <i class="bi bi-diagram-3"></i>
                                </button>
                            </div>
                        </div>
                    `);
                    for (var lan_i = 0; lan_i < num_lans; lan_i++) {
                        var class_col = gen_class_name_edit_col(multilan_classes[lan_i][class_i],
                            languages[lan_i].code);
                        class_row.append(class_col);
                    }
                    $('#class-edit-container').append(class_row);

                }
                $('#class-edit-container').sortable({ items: ".class-row" });

                class_order_save_btn.removeClass('disabled');
                $('#class-edit-container').find('.class-remove-btn').on('click', class_remove_btn_click_listener);
                $('#class-edit-container').find('.edit-icon-btn').on('click', edit_icon_open_listener);
                $('#class-edit-container').find('.edit-child-btn').on('click', edit_child_open_listener);
            });
        });
    }

    class_order_save_btn.on('click', () => {
        loading_state_btn(class_order_save_btn);
        var class_orders = [];
        $('#class-edit-container').find('.class-row').each((order, row) => {
            class_orders.push({
                'class_id': $(row).attr('class-id'),
                'order': order
            });
        });
        send_post('/edit_class_order', {
            "class_orders": class_orders
        }).then(() => {
            finished_state_btn(class_order_save_btn);
        })
    })

    function switch_language_listener() {
        render_page_basic();
    }

    function gen_class_name_edit_col(class_item, lan_code, rm_ok_btn) {
        var col = $(`
            <div class="col class-name-edit-col" lan-code="${lan_code}">
                <div class="input-group class-name-edit-group">
                    <input type="text" class="form-control" placeholder="Class Name" value="${class_item.name}">
                    <button class="input-group-text text-success px-1 class-name-edit-ok-btn">
                        <div class="spinner-border spinner-border-sm d-none"></div>
                        <i class="bi bi-check-lg"></i>
                    </button>
                </div>
            </div>
        `);

        if (rm_ok_btn) {
            col.find('.class-name-edit-ok-btn').remove();
        } else {
            var ok_btn = col.find('.class-name-edit-ok-btn');
            ok_btn.on('click', () => {
                var class_name = validate_input(col.find('.class-name-edit-group'));
                if (class_name.length) {
                    loading_state_btn(ok_btn);
                    send_post('/edit_class_name', {
                        'class_id': class_item.ID,
                        'lan_code': lan_code,
                        'class_name': class_name
                    }).then(() => {
                        finished_state_btn(ok_btn);
                    })
                }
            })
        }

        return col;
    }

    function gen_new_class_row(languages) {
        var row = $(`
            <div class="${class_row_common_class}" id="new-class-row" style="background-color: #D7CCC8">
                <div class="col d-flex align-items-center justify-content-evenly">
                    <button class="btn btn-dark edit-icon-btn border-0" class-id="new-class">
                        <i class="bi bi-question-lg"></i>
                    </button>
                    <button class="btn btn-warning">
                        <i class="bi bi-x-lg"></i>
                    </button>
                    <button class="btn btn-success" id="class-add-ok-btn">
                        <div class="spinner-border spinner-border-sm d-none"></div>
                        <i class="bi bi-check-lg"></i>
                    </button>
                </div>
            </div>
        `);

        languages.forEach((language) => {
            row.append(`
                <div class="col new-class-col" lan-code=${language.code}>
                    <input type="text" class="form-control" placeholder="Class Name">
                </div>
            `);
        });

        var ok_btn = row.find('#class-add-ok-btn');
        ok_btn.on('click', () => {
            var valid_flag = true;
            var new_classes = [];
            $('#new-class-row').find('.new-class-col').each((index, col) => {
                var lan_code = $(col).attr('lan-code');
                var class_name = validate_input($(col));
                if (class_name.length === 0) { valid_flag = false; }
                new_classes.push({
                    'lan_code': lan_code,
                    'class_name': class_name,
                })
            });
            if (valid_flag) {
                loading_state_btn(ok_btn);

                var new_class_icon_btn = $('.edit-icon-btn[class-id="new-class"]');
                var icon_name = new_class_icon_btn.find('.bi').attr('class').match(/bi-(\S+)/)[1];
                var icon_style = rgb_to_hex(new_class_icon_btn.css('background-color'));
                send_post('/add_parent_class', {
                    'class_names': new_classes,
                    'icon': icon_name,
                    'icon_style': icon_style
                }).then((data) => {
                    finished_state_btn(ok_btn);
                    location.reload();
                })
            }
        })

        return row;
    }

    function class_remove_btn_click_listener(evnet) {
        var target = $(event.target);
        var class_id = target.parents('.class-row').attr('class-id');

        send_post('/remove_class', {
            'class_id': class_id
        }).then((data) => {
            if (data.message === 'fail') {
                show_warning_toast('You can only delete classes that are not tagged to any function.');
            } else {
                location.reload();
            }
        })
    }

    function edit_icon_open_listener(event) {
        var target = $(event.target);
        if (target.hasClass('bi')) {
            target = $(event.target).parent('.edit-icon-btn');
        }

        var icon_name = target.find('.bi').attr('class').match(/bi-(\S+)/)[1];
        var icon_style = rgb_to_hex(target.css('background-color'));
        $('#icon-name-input input').val(icon_name);
        $('#icon-style-input input').val(icon_style);

        var target_class_id = target.attr('class-id');
        $('#edit-icon-dialog').attr('class-id', target_class_id);
        edit_icon_dialog_bs.show();
    }

    $('#edit-icon-ok-btn').on('click', () => {
        var target_class_id = $('#edit-icon-dialog').attr('class-id');
        var icon_name = validate_input($('#icon-name-input'));
        var icon_style = validate_input($('#icon-style-input'));

        if (icon_name.length > 0 && icon_style.length > 0) {
            var target_btn = $(`.edit-icon-btn[class-id="${target_class_id}"]`);
            target_btn.find('.bi').attr('class', `bi bi-${icon_name}`);
            target_btn.css(`background-color`, `#${icon_style}`);
            edit_icon_dialog_bs.hide();
            $('#edit-icon-dialog').find('input').val('');

            if (target_class_id !== 'new-class') {
                send_post('/edit_class_icon', {
                    'class_id': target_class_id,
                    'icon': icon_name,
                    'icon_style': icon_style
                })
            }
        }
    })

    function gen_child_class_edit_row(class_id, state) {
        var child_row = $(`
            <div class="${child_class_row_common_class} child-class-row position-relative" class-id="${class_id}" state="${state}">
                <button class="btn badge position-absolute top-0 start-0 m-0 p-0 text-bg-danger child-remove-btn" 
                style="width: 25px; height: 15px; z-index: 999">
                    <small><i class="bi bi-x-lg"></i></small>
                </button>
            </div>
        `);
        if (state === 'existing') {
            child_row.css('background-color', '#eee');
        } else if (state === 'new') {
            child_row.css('background-color', '#FFECB3');
        }

        child_row.find('.child-remove-btn').on('click', () => {
            if (state === 'existing') {
                child_row.attr('state', 'delete');
                child_row.addClass('d-none');
            } else {
                child_row.remove();
            }
        });
        return child_row;
    }

    function edit_child_open_listener(event) {
        var target = $(event.target);
        var parent_class_id = target.parents('.class-row').attr('class-id');
        var edit_child_dialog = $('#edit-child-dialog');
        edit_child_dialog.find('.modal-footer button').addClass('disabled');
        edit_child_dialog.attr('parent-class-id', parent_class_id);
        edit_child_dialog_bs.show();

        var name_promises = [];
        send_post('/fetch_child_class', { 'parent_id': parent_class_id }).then((data) => {
            var lan_codes = [];
            $('#child-class-edit-container .child-class-row').remove();
            $('#language-row .lan-col').each((index, col) => { lan_codes.push($(col).attr('lan-code')) });
            data.content.forEach((children) => {
                var child_row = gen_child_class_edit_row(children[0], 'existing');
                lan_codes.forEach((lan_code) => {
                    child_row.append(gen_class_name_edit_col({ 'ID': children[0], 'name': children[1][lan_code] }, lan_code, true));
                });
                $('#child-class-edit-container').append(child_row);
            });
            $('#child-class-edit-container').sortable({ items: '.child-class-row' });

            edit_child_dialog.find('.modal-footer button').removeClass('disabled');
        });
    }

    $('#add-child-class-btn').on('click', () => {
        var new_child_row = gen_child_class_edit_row('', 'new');
        var lan_codes = [];
        $('#language-row .lan-col').each((index, col) => { lan_codes.push($(col).attr('lan-code')) });
        lan_codes.forEach((lan_code) => {
            new_child_row.append(gen_class_name_edit_col({ 'ID': '', 'name': '' }, lan_code, true));
        });
        $('#child-class-edit-container').append(new_child_row);
    })

    $('#edit-child-class-ok-btn').on('click', () => {
        var parent_class_id = $('#edit-child-dialog').attr('parent-class-id');
        var childrens = [];
        var valid_flag = true;
        $('#child-class-edit-container .child-class-row').each((index, row) => {
            var state = $(row).attr('state');
            var class_id = $(row).attr('class-id');
            var children_names = [];
            $(row).find('.class-name-edit-col').each((j, col) => {
                var name = {
                    'lan_code': $(col).attr('lan-code'),
                    'name': validate_input($(col).find('.class-name-edit-group'))
                };
                if (name['name'].length === 0) { valid_flag = false; }
                children_names.push(name);
            });
            childrens.push({
                'state': state,
                'class_id': class_id,
                'names': children_names
            });
        });

        if (valid_flag) {
            loading_state_btn($('#edit-child-class-ok-btn'));
            send_post('/modify_child_class', {
                'parent_id': parent_class_id,
                'childrens': childrens
            }).then((data) => {
                finished_state_btn($('#edit-child-class-ok-btn'));
                if (data.message === 'fail') {
                    show_warning_toast('Failed to finish children class modification: try to delete classes that are attached to functions.');
                } else {
                    edit_child_dialog_bs.hide();
                }
            })
        }
    })
</script>
{% endblock %}